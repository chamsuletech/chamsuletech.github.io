---
layout: post
title:  웨어러블 외부 동작 기술문서
date:   2022-12-14 10:33:35 +0300
image:  09.jpg
tags:   Resources
---
참슬테크에서 만든 Wearable 기술문서입니다.

***

## 1.	개요
해당 문서는 Smart One Pass(이하 원패스) 시스템에서 웨어러블 기기가 원패스 시스템에 연동되는 자사의 다른 기기와 상호작용하여 동작하는 시나리오에 대한 문서입니다. 웨어러블 기기는 양산 절차 및 원패스 시스템에서 사용되기 위해 외부 기기와 두 가지 무선 통신 방식을 사용합니다. 근접태그 방식과 BLE 방식을 사용하여 외부 기기와 통신합니다.


## 2.	시스템 구성도
웨어러블 기기는 하드웨어 생산 및 펌웨어 다운로드를 마치고 나서 원패스 시스템 내부에서 기기 운용에 필요한 KEY ID를 등록하는 KEY ID 등록 과정과 기기가 동작하면서 시간 동기화, 공동 현관 인증 등 기능 수행을 위해 다른 기기들과 상호작용 하는 것에 대하여 아래의 구성도로 나타내었습니다.

![]({{ site.baseurl }}/images/wearable/시스템 구성도.png)

## 3.	통신 방식
### 근접태그 방식
근접태그 방식은 RFID 태그(NFC-A Type)를 사용합니다. 웨어러블 기기 내부에 있는 NFC 모듈의 고유 번호를 이용하여 통신합니다. NFC 모듈의 고유 번호는 웨어러블 기기의 양산 과정에서 만들어지며 웨어러블 기기의 내부 제어 및 외부 통신으로 변경 할 수 없습니다. NFC 모듈의 고유 번호는 일련의 변환 과정을 거쳐 만들어진 16자리 16진수(8-Byte Data)는 원패스 시스템에서 웨어러블 기기의 구분을 위한 ID로 사용합니다.
### BLE 방식
BLE 방식은 Bluetooth Low Energy 방식으로 웨어러블 기기가 다른 기기와 데이터를 주고 받기 위해 사용합니다. BLE 통신은 Bluetooth Connection을 하지 않고 Advertising과 Scan을 하며 i-Beacon과 유사한 데이터 구성을 가집니다. BLE 통신 데이터는 웨어러블 기기 내부에서 제어하며 해당 문서에서는 데이터 구성과 관련된 프로토콜은 다루지 않습니다.

## 4.	통신 시퀀스 및 Flow Chart
웨어러블 기기의 운용에 필요한 1) KEY ID 등록과 기능과 관련된 2) 시간 동기화, 3) 주차 위치 확인, 4) 공동 현관 인증, 5) 출입 위치 확인 기능들의 통신 과정에 대한 시나리오 및 웨어러블 기기의 간단한 동작 Flow Chart를 기술합니다. 웨어러블 기기의 상세한 동작 Flow Chart는 내부 동작 기술문서를 참고 바랍니다.
### KEY ID 등록
<span style="color:red">
※ 해당 문서에서 다루는 KEY ID 등록은 웨어러블 기기가 자신의 NFC 모듈의 고유 번호를 통해 KEY ID를 전달받아 저장하는 양산 과정의 KEY ID 등록입니다. 현장의 방재실 및 관리사무소에서 서버에 등록하기 위한 KEY ID 등록은 해당 문서에서 다루지 않습니다. 때문에 여기서 언급하는 등록기는 현장의 방재실 및 관리사무소에서 사용하는 서버에 등록하기 위한 등록기가 아닌 웨어러블 기기에 KEY ID 저장을 하기 위해 사용하는 양산 등록기입니다.
</span>

웨어러블 기기는 내부에 있는 NFC 모듈의 고유 번호를 변환하여 8-Byte Data의 KEY ID로 사용합니다. 웨어러블 기기는 NFC Reader의 기능이 없기 때문에 자신의 NFC 모듈의 고유 번호를 스스로 생성 할 수 없으므로 NFC Reader와 BLE 송수신 기능이 있는 양산 등록기에 근접태그를 하여 등록과 관련된 BLE 신호를 수신하고 해당 KEY ID를 저장 합니다.

![통신시퀀스 - 양산등록기]({{ site.baseurl }}/images/wearable/시퀀스_KEY ID 등록.png)

![FlowChart]({{ site.baseurl }}/images/wearable/Flow Chart_KEY ID 등록.png)

### 시간 동기화
웨어러블 기기는 Main Core와 별개로 시간을 측정하는 RTC 없이 Main Core의 Timer로 시간을 측정하기 때문에 시간 측정에 대하여 정밀하지 못하고, 재부팅시 현재 시간이 초기화 됩니다. 이러한 이유로 현재 시간을 표시하기 위해 외부 기기(스마트폰)에서 시간 데이터를 주기적으로 요청하여 현재 시간을 표시 합니다. 시간 동기화는 기기가 부팅하고 즉시 진행하며 시간 동기화에 성공하면 86400초(24시간) 이후에 재 진행하고, 시간 동기화에 실패하면 3600초(1시간) 이후에 재 진행 합니다. 또한, 메인 화면에서 시간이 표시되는 구역을 누르면 즉시 시간 동기화를 진행 합니다.

![통신 시퀀스 – 스마트폰]({{ site.baseurl }}/images/wearable/시퀀스_시간 동기화.png)

![FlowChart]({{ site.baseurl }}/images/wearable/Flow Chart_시간 동기화.png)

### 주차 위치 확인
웨어러블 기기 Ver 1.0.1에서는 외부 기기(ex. 비상벨, 만공등)에서 기둥 정보를 보내주는 주차 위치 비콘 신호들을 SCAN 하여 신호의 세기가 가장 강한 신호의 주차 위치를 표시하는 ‘자기 판단형’의 주차 위치 확인만 가능 합니다.

![통신 시퀀스 – 비상벨]({{ site.baseurl }}/images/wearable/시퀀스_주차 위치 확인.png)

![FlowChart]({{ site.baseurl }}/images/wearable/Flow Chart_주차 위치 확인.png)

### 공동 현관 인증
웨어러블 기기는 공동 현관 비콘 신호를 SCAN 하면 KEY ID와 문열림 데이터를 전송하여 공동 현관 인증을 합니다. 공동 현관 인증을 위해 웨어러블 기기는 BLE 신호에 대하여 상시적으로 SCAN 하고 있습니다.

![통신 시퀀스 – 공동 현관 리더기]({{ site.baseurl }}/images/wearable/시퀀스_공동 현관 인증.png)

![FlowChart]({{ site.baseurl }}/images/wearable/Flow Chart_공동 현관 인증.png)

### 출입 위치 확인
공동 현관 리더기는 FMCW로 모션 인식 및 방향을 탐지합니다. 이때 현장에 따라 건물 내부에서 외부로 나오는 것을 확실하게 인식하기 위해 ‘EV-Hall 리더기’를 추가로 설치한다. 웨어러블 기기는 EV-Hall 리더기 비콘 신호를 수신하면 공동현관 인증 신호를 전송하지 않습니다.

![통신 시퀀스 – EV-Hall 리더기]({{ site.baseurl }}/images/wearable/시퀀스_출입 위치 확인.png)

![FlowChart]({{ site.baseurl }}/images/wearable/Flow Chart_출입 위치 확인.png)
